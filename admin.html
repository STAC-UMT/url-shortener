<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin - R√∫t g·ªçn Link</title>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:500px;margin:2rem auto;padding:0 1rem;background:#f6f8fa}
        .card{background:#fff;padding:2rem;border-radius:6px;box-shadow:0 1px 3px rgba(0,0,0,0.12);border:1px solid #d0d7de}
        h2{margin-top:0;color:#24292f;text-align:center}
        label{display:block;margin-bottom:8px;font-weight:600;color:#24292f}
        input{width:100%;padding:8px 12px;margin-bottom:16px;border:1px solid #d0d7de;border-radius:6px;box-sizing:border-box}
        
        /* Button ch√≠nh */
        .btn-primary{width:100%;background:#2da44e;color:#fff;border:none;padding:10px;border-radius:6px;font-weight:600;cursor:pointer}
        .btn-primary:hover{background:#2c974b}
        .btn-primary:disabled{background:#94d3a2;cursor:not-allowed}

        /* Status Box */
        #status{margin-top:16px;padding:12px;border-radius:6px;font-size:14px;display:none;word-break: break-all;}
        .success{background:#dafbe1;color:#1a7f37;border:1px solid #aceebb}
        .error{background:#ffebe9;color:#cf222e;border:1px solid #ff8182}
        
        /* Button Copy nh·ªè */
        .btn-copy {
            background: #fff; border: 1px solid #1a7f37; color: #1a7f37;
            padding: 2px 8px; border-radius: 4px; font-size: 12px; 
            cursor: pointer; margin-left: 8px; font-weight: 600;
        }
        .btn-copy:hover { background: #e6ffec; }

        .hint{font-size:12px;color:#57606a;margin-top:-12px;margin-bottom:16px;display:block}
    </style>
</head>
<body>
    <div class="card">
        <h2>üîó T·∫°o Link R√∫t G·ªçn</h2>
        
        <label>Link g·ªëc (URL ƒë√≠ch)</label>
        <input type="url" id="longUrl" placeholder="https://..." required>

        <label>M√£ r√∫t g·ªçn (Slug)</label>
        <input type="text" id="shortSlug" placeholder="vd: my-cv, fb" required>
        <small class="hint" id="slugHint">Link s·∫Ω l√†: ...</small>

        <label>GitHub Token</label>
        <input type="password" id="ghToken" placeholder="github_pat_...">
        
        <button id="btnCreate" class="btn-primary" onclick="createLink()">T·∫°o Link</button>
        <div id="status"></div>
    </div>

    <script>
        // --- C·∫§U H√åNH (S·ª¨A L·∫†I TH√îNG TIN C·ª¶A B·∫†N) ---
        const CONFIG = {
            owner: 'stac-umt', // Username GitHub
            repo: 'url-shortener',  // T√™n Repo
            path: 'links.json'
        };

        // --- KH·ªûI T·∫†O ---
        const savedToken = localStorage.getItem('gh_token');
        if (savedToken) document.getElementById('ghToken').value = savedToken;

        // T·ª± ƒë·ªông hi·ªÉn th·ªã Hint URL d·ª±a tr√™n Config
        const baseUrl = `https://${CONFIG.owner}.github.io/${CONFIG.repo}`;
        document.getElementById('slugHint').innerText = `Link s·∫Ω l√†: ${baseUrl}/[slug]`;

        async function createLink() {
            const ui = {
                btn: document.getElementById('btnCreate'),
                status: document.getElementById('status'),
                long: document.getElementById('longUrl').value.trim(),
                slug: document.getElementById('shortSlug').value.trim(),
                token: document.getElementById('ghToken').value.trim()
            };

            if (!ui.long || !ui.slug || !ui.token) return showMsg('Vui l√≤ng ƒëi·ªÅn ƒë·ªß th√¥ng tin!', 'error');

            ui.btn.disabled = true;
            ui.btn.textContent = "ƒêang x·ª≠ l√Ω...";
            localStorage.setItem('gh_token', ui.token);

            try {
                // 1. Get current data
                const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
                const getRes = await fetch(apiUrl, {
                    headers: { 'Authorization': `Bearer ${ui.token}` }
                });
                
                if (!getRes.ok) throw new Error('L·ªói k·∫øt n·ªëi ho·∫∑c sai Token!');
                
                const fileData = await getRes.json();
                const content = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

                // 2. Check duplicate
                if (content[ui.slug]) throw new Error(`M√£ "${ui.slug}" ƒë√£ t·ªìn t·∫°i!`);

                // 3. Update data
                content[ui.slug] = ui.long;
                const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

                // 4. Commit
                const putRes = await fetch(apiUrl, {
                    method: 'PUT',
                    headers: {
                        'Authorization': `Bearer ${ui.token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        message: `Add link: ${ui.slug}`,
                        content: newContent,
                        sha: fileData.sha
                    })
                });

                if (!putRes.ok) throw new Error('Kh√¥ng th·ªÉ l∆∞u file l√™n GitHub.');

                // --- X·ª¨ L√ù HI·ªÇN TH·ªä TH√ÄNH C√îNG (M·ªöI) ---
                const fullLink = `${baseUrl}/${ui.slug}`;
                
                const successMsg = `
                    ‚úÖ <b>Th√†nh c√¥ng!</b><br>
                    <div style="margin-top:5px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                        <a href="${fullLink}" target="_blank" style="color:#1a7f37; font-weight:bold; text-decoration:none;">${fullLink}</a>
                        <button class="btn-copy" onclick="copyText('${fullLink}', this)">Copy</button>
                    </div>
                    <small style="color:#57606a; display:block; margin-top:5px;">(Link s·∫Ω ho·∫°t ƒë·ªông sau 1-2 ph√∫t)</small>
                `;

                showMsg(successMsg, 'success');
                
                // Clear inputs
                document.getElementById('shortSlug').value = '';
                document.getElementById('longUrl').value = '';

            } catch (err) {
                showMsg(err.message, 'error');
            } finally {
                ui.btn.disabled = false;
                ui.btn.textContent = "T·∫°o Link";
            }
        }

        function showMsg(htmlContent, type) {
            const el = document.getElementById('status');
            el.innerHTML = htmlContent;
            el.className = type;
            el.style.display = 'block';
        }

        // H√†m Copy v√†o Clipboard
        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "ƒê√£ Copy!";
                setTimeout(() => {
                    btn.innerText = originalText;
                }, 2000);
            }).catch(err => {
                console.error('Kh√¥ng th·ªÉ copy:', err);
                alert('L·ªói copy, b·∫°n h√£y b√¥i ƒëen v√† copy th·ªß c√¥ng.');
            });
        }
    </script>
</body>
</html>