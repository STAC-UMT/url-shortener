<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>STAC - Tr√¨nh qu·∫£n l√Ω R√∫t g·ªçn & QR Code</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <style>
        body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif;max-width:550px;margin:2rem auto;padding:0 1rem;background:#f6f8fa}
        .card{background:#fff;padding:2rem;border-radius:8px;box-shadow:0 4px 6px rgba(0,0,0,0.05);border:1px solid #d0d7de}
        h2{margin-top:0;color:#24292f;text-align:center}
        label{display:block;margin-bottom:8px;font-weight:600;color:#24292f}
        input{width:100%;padding:10px 12px;margin-bottom:16px;border:1px solid #d0d7de;border-radius:6px;box-sizing:border-box;transition: 0.2s;}
        input:focus{outline: none; border-color: #00a8e5; box-shadow: 0 0 0 3px rgba(0, 168, 229, 0.2);}
        input:disabled{background: #eaeeef; cursor: not-allowed;}
        
        .mode-selection { display: flex; gap: 15px; margin-bottom: 20px; padding: 10px; background: #f0f3f6; border-radius: 6px; }
        .mode-selection label { font-weight: normal; margin: 0; display: flex; align-items: center; gap: 5px; cursor: pointer; }

        .btn-primary{width:100%;background:#00a8e5;color:#fff;border:none;padding:12px;border-radius:6px;font-weight:bold;cursor:pointer;font-size:15px;transition: 0.2s;}
        .btn-primary:hover{background:#008fc2}
        .btn-primary:disabled{background:#8cdbfa;cursor:not-allowed}

        #status{margin-top:16px;padding:15px;border-radius:6px;font-size:14px;display:none;word-break: break-all;}
        .success{background:#f0fbff;color:#00739e;border:1px solid #b3e9ff}
        .error{background:#ffebe9;color:#cf222e;border:1px solid #ff8182}
        
        .btn-copy { background: #fff; border: 1px solid #00a8e5; color: #00a8e5; padding: 4px 10px; border-radius: 4px; font-size: 12px; cursor: pointer; margin-left: 8px; font-weight: 600;}
        .btn-copy:hover { background: #e6f6fc; }
        
        .hint{font-size:12px;color:#57606a;margin-top:-12px;margin-bottom:16px;display:block}
        
        /* Ch·ªânh style khu v·ª±c hi·ªÉn th·ªã QR */
        #qrDisplayArea { margin-top: 15px; display: flex; flex-direction: column; align-items: center; gap: 10px; }
        #qrCanvas { padding: 10px; background: white; border: 1px solid #d0d7de; border-radius: 8px; display: inline-block; }
        .btn-download { background: #24292f; color: white; border: none; padding: 8px 16px; border-radius: 4px; font-size: 13px; font-weight: 600; cursor: pointer; }
        .btn-download:hover { background: #424a53; }
    </style>
</head>
<body>
    <div class="card">
        <h2>üîó Qu·∫£n l√Ω Link & QR Code</h2>
        
        <label>Ch·ªçn ch·ª©c nƒÉng:</label>
        <div class="mode-selection">
            <label><input type="checkbox" id="cbShort" checked onchange="toggleInputs()"> R√∫t g·ªçn Link</label>
            <label><input type="checkbox" id="cbQR" checked onchange="toggleInputs()"> T·∫°o m√£ QR</label>
        </div>

        <label>Link g·ªëc (URL ƒë√≠ch)</label>
        <input type="url" id="longUrl" placeholder="https://..." required>

        <div id="shortLinkArea">
            <label>M√£ r√∫t g·ªçn (Slug)</label>
            <input type="text" id="shortSlug" placeholder="vd: my-cv, fb">
            <small class="hint" id="slugHint">Link s·∫Ω l√†: ...</small>

            <label>GitHub Token</label>
            <input type="password" id="ghToken" placeholder="github_pat_...">
        </div>
        
        <button id="btnCreate" class="btn-primary" onclick="processData()">X·ª≠ l√Ω ngay</button>
        <div id="status"></div>
    </div>

    <script>
        // --- C·∫§U H√åNH ---
        const CONFIG = {
            owner: 'stac-umt', // Username/Organization GitHub
            repo: 'url-shortener',  // T√™n Repo
            path: 'links.json'
        };

        const baseUrl = `https://${CONFIG.owner}.github.io/${CONFIG.repo}`;
        document.getElementById('slugHint').innerText = `Link s·∫Ω l√†: ${baseUrl}/[slug]`;

        const savedToken = localStorage.getItem('gh_token');
        if (savedToken) document.getElementById('ghToken').value = savedToken;

        // H√†m b·∫≠t/t·∫Øt c√°c √¥ nh·∫≠p li·ªáu t√πy theo ch·∫ø ƒë·ªô ƒë∆∞·ª£c ch·ªçn
        function toggleInputs() {
            const isShort = document.getElementById('cbShort').checked;
            const isQR = document.getElementById('cbQR').checked;
            
            // N·∫øu kh√¥ng ch·ªçn g√¨ th√¨ √©p ch·ªçn √≠t nh·∫•t 1 c√°i
            if (!isShort && !isQR) {
                document.getElementById('cbShort').checked = true;
                return toggleInputs();
            }

            const shortArea = document.getElementById('shortLinkArea');
            if (isShort) {
                shortArea.style.display = 'block';
            } else {
                shortArea.style.display = 'none';
            }
        }

        async function processData() {
            const isShort = document.getElementById('cbShort').checked;
            const isQR = document.getElementById('cbQR').checked;
            
            const longUrl = document.getElementById('longUrl').value.trim();
            const shortSlug = document.getElementById('shortSlug').value.trim();
            const token = document.getElementById('ghToken').value.trim();
            const btn = document.getElementById('btnCreate');

            if (!longUrl) return showMsg('Vui l√≤ng nh·∫≠p Link g·ªëc!', 'error');
            if (isShort && !shortSlug) return showMsg('Vui l√≤ng nh·∫≠p M√£ r√∫t g·ªçn (Slug)!', 'error');
            if (isShort && !token) return showMsg('Vui l√≤ng nh·∫≠p GitHub Token!', 'error');

            btn.disabled = true;
            btn.textContent = "ƒêang x·ª≠ l√Ω...";
            document.getElementById('status').style.display = 'none'; // ·∫®n th√¥ng b√°o c≈©

            try {
                let targetUrlForQR = longUrl; // M·∫∑c ƒë·ªãnh QR s·∫Ω tr·ªè v·ªÅ link g·ªëc
                let successHtml = `‚úÖ <b>X·ª≠ l√Ω th√†nh c√¥ng!</b><br>`;

                // 1. N·∫øu ch·ªçn R√∫t g·ªçn link -> X·ª≠ l√Ω API GitHub
                if (isShort) {
                    localStorage.setItem('gh_token', token);
                    await handleGitHubAPI(longUrl, shortSlug, token);
                    
                    targetUrlForQR = `${baseUrl}/${shortSlug}`; // N·∫øu c√≥ r√∫t g·ªçn, QR s·∫Ω tr·ªè v·ªÅ link r√∫t g·ªçn
                    
                    successHtml += `
                        <div style="margin-top:8px; display:flex; align-items:center; flex-wrap:wrap; gap:5px;">
                            <a href="${targetUrlForQR}" target="_blank" style="color:#00a8e5; font-weight:bold; text-decoration:none;">${targetUrlForQR}</a>
                            <button class="btn-copy" onclick="copyText('${targetUrlForQR}', this)">Copy</button>
                        </div>
                        <small style="color:#57606a; display:block; margin-top:5px;">(Link r√∫t g·ªçn s·∫Ω ho·∫°t ƒë·ªông sau 1-2 ph√∫t)</small>
                    `;
                    
                    // X√≥a form slug sau khi t·∫°o th√†nh c√¥ng
                    document.getElementById('shortSlug').value = '';
                }

                // 2. N·∫øu ch·ªçn Sinh QR
                if (isQR) {
                    successHtml += `
                        <div id="qrDisplayArea">
                            <div id="qrCanvas"></div>
                            <button class="btn-download" onclick="downloadQR('${isShort ? shortSlug : 'qrcode'}')">‚¨á T·∫£i M√£ QR (.png)</button>
                        </div>
                    `;
                }

                showMsg(successHtml, 'success');

                // Render QR code v√†o th·∫ª div v·ª´a t·∫°o
                if (isQR) {
                    const qrContainer = document.getElementById("qrCanvas");
                    qrContainer.innerHTML = ""; // Clear c≈©
                    new QRCode(qrContainer, {
                        text: targetUrlForQR,
                        width: 220,
                        height: 220,
                        colorDark : "#000000",
                        colorLight : "#ffffff",
                        correctLevel : QRCode.CorrectLevel.H
                    });
                }

            } catch (err) {
                showMsg(`‚ùå L·ªói: ${err.message}`, 'error');
            } finally {
                btn.disabled = false;
                btn.textContent = "X·ª≠ l√Ω ngay";
            }
        }

        // T√°ch ri√™ng logic x·ª≠ l√Ω GitHub API cho s·∫°ch code
        async function handleGitHubAPI(longUrl, shortSlug, token) {
            const apiUrl = `https://api.github.com/repos/${CONFIG.owner}/${CONFIG.repo}/contents/${CONFIG.path}`;
            
            // L·∫•y data hi·ªán t·∫°i
            const getRes = await fetch(apiUrl, { headers: { 'Authorization': `Bearer ${token}` } });
            if (!getRes.ok) throw new Error('Kh√¥ng th·ªÉ k·∫øt n·ªëi GitHub (Sai token ho·∫∑c Repo ri√™ng t∆∞ nh∆∞ng ch∆∞a c·∫•p quy·ªÅn).');
            
            const fileData = await getRes.json();
            const content = JSON.parse(decodeURIComponent(escape(atob(fileData.content))));

            // Ki·ªÉm tra tr√πng
            if (content[shortSlug]) throw new Error(`M√£ r√∫t g·ªçn "${shortSlug}" ƒë√£ t·ªìn t·∫°i!`);

            // Th√™m m·ªõi
            content[shortSlug] = longUrl;
            const newContent = btoa(unescape(encodeURIComponent(JSON.stringify(content, null, 2))));

            // Commit
            const putRes = await fetch(apiUrl, {
                method: 'PUT',
                headers: { 'Authorization': `Bearer ${token}`, 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    message: `Add link: ${shortSlug}`,
                    content: newContent,
                    sha: fileData.sha
                })
            });

            if (!putRes.ok) throw new Error('L·ªói khi l∆∞u d·ªØ li·ªáu l√™n GitHub.');
        }

        function showMsg(htmlContent, type) {
            const el = document.getElementById('status');
            el.innerHTML = htmlContent;
            el.className = type;
            el.style.display = 'block';
        }

        function copyText(text, btn) {
            navigator.clipboard.writeText(text).then(() => {
                const originalText = btn.innerText;
                btn.innerText = "ƒê√£ Copy!";
                setTimeout(() => { btn.innerText = originalText; }, 2000);
            });
        }

        function downloadQR(filename) {
            const canvas = document.querySelector('#qrCanvas canvas');
            if (!canvas) return alert('Kh√¥ng t√¨m th·∫•y m√£ QR ƒë·ªÉ t·∫£i.');
            const url = canvas.toDataURL("image/png");
            const a = document.createElement('a');
            a.href = url;
            a.download = `QR_${filename}.png`;
            a.click();
        }
    </script>
</body>
</html>